<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teste do Sistema MMR/LP</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: #0a1428;
            color: #c9aa71;
        }
        .container {
            background: rgba(16, 29, 53, 0.8);
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 20px;
        }
        .endpoint {
            background: rgba(30, 35, 47, 0.6);
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
        }
        button {
            background: #c89b3c;
            color: #0a1428;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #f0e6d2;
        }
        .result {
            background: rgba(200, 155, 60, 0.1);
            padding: 10px;
            border-radius: 5px;
            margin-top: 10px;
            white-space: pre-wrap;
        }
        .positive { color: #10b981; }
        .negative { color: #ef4444; }
        input {
            background: rgba(30, 35, 47, 0.8);
            border: 1px solid rgba(200, 155, 60, 0.3);
            color: #c9aa71;
            padding: 8px;
            border-radius: 4px;
            margin: 5px;
        }
    </style>
</head>
<body>
    <h1>üéÆ Teste do Sistema MMR/LP para Partidas Customizadas</h1>
    
    <div class="container">
        <h2>üìä Consultar Stats de Jogador</h2>
        <div class="endpoint">
            <label>Nome do Jogador:</label>
            <input type="text" id="playerName" placeholder="Digite o nome do jogador" value="TestPlayer">
            <button onclick="getPlayerStats()">Buscar Stats</button>
            <div id="playerStatsResult" class="result" style="display: none;"></div>
        </div>
    </div>

    <div class="container">
        <h2>üîß Recalcular LP de Todas as Partidas</h2>
        <div class="endpoint">
            <button onclick="recalculateLP()">Recalcular LP</button>
            <div id="recalculateResult" class="result" style="display: none;"></div>
        </div>
    </div>

    <div class="container">
        <h2>üéØ Buscar Partidas Customizadas</h2>
        <div class="endpoint">
            <label>Player ID/Nome:</label>
            <input type="text" id="matchPlayerName" placeholder="Digite o nome do jogador" value="TestPlayer">
            <button onclick="getCustomMatches()">Buscar Partidas</button>
            <div id="customMatchesResult" class="result" style="display: none;"></div>
        </div>
    </div>

    <div class="container">
        <h2>üßÆ Simulador de C√°lculo de LP</h2>
        <div class="endpoint">
            <label>MMR do Jogador:</label>
            <input type="number" id="playerMMR" value="1000" min="500" max="3000">
            
            <label>MMR do Oponente:</label>
            <input type="number" id="opponentMMR" value="1000" min="500" max="3000">
            
            <label>Resultado:</label>
            <select id="gameResult">
                <option value="true">Vit√≥ria</option>
                <option value="false">Derrota</option>
            </select>
            
            <button onclick="simulateLP()">Calcular LP</button>
            <div id="simulateResult" class="result" style="display: none;"></div>
        </div>
    </div>

    <script>
        const API_BASE = 'http://localhost:3000/api';

        async function getPlayerStats() {
            const playerName = document.getElementById('playerName').value;
            const resultDiv = document.getElementById('playerStatsResult');
            
            if (!playerName) {
                alert('Digite um nome de jogador');
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/player/${encodeURIComponent(playerName)}/custom-stats`);
                const data = await response.json();
                
                if (data.success) {
                    const player = data.player;
                    resultDiv.innerHTML = `
<strong>üìà Stats de ${player.summoner_name}</strong>
MMR Atual: ${player.custom_mmr}
MMR Peak: ${player.custom_peak_mmr}
Partidas Jogadas: ${player.custom_games_played}
Vit√≥rias: ${player.custom_wins}
Derrotas: ${player.custom_losses}
Win Rate: ${player.custom_winrate}%
Win Streak: ${player.custom_win_streak}
                    `;
                } else {
                    resultDiv.innerHTML = `‚ùå Erro: ${data.error}`;
                }
                
                resultDiv.style.display = 'block';
            } catch (error) {
                resultDiv.innerHTML = `‚ùå Erro de conex√£o: ${error.message}`;
                resultDiv.style.display = 'block';
            }
        }

        async function recalculateLP() {
            const resultDiv = document.getElementById('recalculateResult');
            
            try {
                const response = await fetch(`${API_BASE}/admin/recalculate-custom-lp`, {
                    method: 'POST'
                });
                const data = await response.json();
                
                if (data.success) {
                    resultDiv.innerHTML = `
<strong>‚úÖ Rec√°lculo Conclu√≠do</strong>
${data.message}
Total de Partidas: ${data.totalMatches}
Partidas Atualizadas: ${data.updatedMatches}
                    `;
                } else {
                    resultDiv.innerHTML = `‚ùå Erro: ${data.error}`;
                }
                
                resultDiv.style.display = 'block';
            } catch (error) {
                resultDiv.innerHTML = `‚ùå Erro de conex√£o: ${error.message}`;
                resultDiv.style.display = 'block';
            }
        }

        async function getCustomMatches() {
            const playerName = document.getElementById('matchPlayerName').value;
            const resultDiv = document.getElementById('customMatchesResult');
            
            if (!playerName) {
                alert('Digite um nome de jogador');
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/matches/custom?playerId=${encodeURIComponent(playerName)}&limit=10`);
                const data = await response.json();
                
                if (data.success && data.matches) {
                    let html = `<strong>üéÆ Partidas de ${playerName}</strong>\n\n`;
                    
                    data.matches.forEach((match, index) => {
                        const lpChange = match.player_lp_change || 0;
                        const lpColor = lpChange > 0 ? 'positive' : 'negative';
                        const resultText = match.player_won ? 'VIT√ìRIA' : 'DERROTA';
                        
                        html += `
Partida ${index + 1} (ID: ${match.id})
Resultado: ${resultText}
LP: <span class="${lpColor}">${lpChange > 0 ? '+' : ''}${lpChange}</span>
Time: ${match.player_team || 'N/A'}
Data: ${new Date(match.created_at).toLocaleString()}
---
                        `;
                    });
                    
                    resultDiv.innerHTML = html;
                } else {
                    resultDiv.innerHTML = `‚ùå Nenhuma partida encontrada ou erro: ${data.error || 'Desconhecido'}`;
                }
                
                resultDiv.style.display = 'block';
            } catch (error) {
                resultDiv.innerHTML = `‚ùå Erro de conex√£o: ${error.message}`;
                resultDiv.style.display = 'block';
            }
        }

        function simulateLP() {
            const playerMMR = parseInt(document.getElementById('playerMMR').value);
            const opponentMMR = parseInt(document.getElementById('opponentMMR').value);
            const isWin = document.getElementById('gameResult').value === 'true';
            const resultDiv = document.getElementById('simulateResult');
            
            // Implementar a mesma l√≥gica do backend
            const mmrDifference = opponentMMR - playerMMR;
            let baseLP = isWin ? 18 : -15;
            
            // Ajuste baseado na diferen√ßa de MMR
            const mmrFactor = mmrDifference / 100;
            const lpAdjustment = mmrFactor * 8;
            
            if (isWin) {
                baseLP += lpAdjustment;
                if (playerMMR < 1200) {
                    baseLP += Math.floor((1200 - playerMMR) / 50);
                }
                if (playerMMR > 1800) {
                    baseLP -= Math.floor((playerMMR - 1800) / 100);
                }
            } else {
                baseLP -= lpAdjustment;
                if (playerMMR < 1200) {
                    baseLP += Math.floor((1200 - playerMMR) / 100);
                }
                if (playerMMR > 1800) {
                    baseLP -= Math.floor((playerMMR - 1800) / 80);
                }
            }
            
            const minLP = isWin ? 8 : -25;
            const maxLP = isWin ? 35 : -8;
            const finalLP = Math.max(minLP, Math.min(maxLP, Math.round(baseLP)));
            
            const lpColor = finalLP > 0 ? 'positive' : 'negative';
            
            resultDiv.innerHTML = `
<strong>üßÆ Resultado da Simula√ß√£o</strong>
Seu MMR: ${playerMMR}
MMR Oponente: ${opponentMMR}
Diferen√ßa: ${mmrDifference} (${mmrDifference > 0 ? 'oponente mais forte' : 'voc√™ mais forte'})
Resultado: ${isWin ? 'VIT√ìRIA' : 'DERROTA'}

LP Calculado: <span class="${lpColor}">${finalLP > 0 ? '+' : ''}${finalLP}</span>

<strong>Detalhes do C√°lculo:</strong>
LP Base: ${isWin ? 18 : -15}
Ajuste por MMR: ${lpAdjustment.toFixed(1)}
Ajuste por Rank: ${baseLP - (isWin ? 18 : -15) - lpAdjustment}
LP Final (com limites): ${finalLP}
            `;
            
            resultDiv.style.display = 'block';
        }
    </script>
</body>
</html>
